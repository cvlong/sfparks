{% extends 'base.html' %}
{% block title %}SFparks{% endblock %}
{% block head %} 
{% endblock %}
{% block body %}
    
    <div>
        <button class="btn btn-default" id="reset-map">Reset map view</button>
    </div>

    <div id='map'></div>

    <nav class='toggle-menu' id='menu'></nav>
    
    <!-- Helper function for lat/lng verification -->
    <!-- <pre id='info'></pre> -->

<script>

var origin = {{ geojson_origin | safe }};
var routing = "{{ routing }}";
var time = {{time}};

var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/cvlong/ciolst186006fbpne0devqoel', 
    center: [origin.geometry.coordinates[0],
             origin.geometry.coordinates[1]
    ]
});

var park_markers = {{ markers | safe }}; // '| safe' to disable HTML autoescape

var park_markers_source = new mapboxgl.GeoJSONSource({
        data: park_markers
    });

// Fit map to boundaries of displayed markers
var bounds = new mapboxgl.LngLatBounds();

park_markers.features.forEach(function(feature) {
    bounds.extend(feature.geometry.coordinates);
});

map.fitBounds(bounds, {padding: '20'});

// Reset map view presented on load
$('#reset-map').on('click', function() {
    map.fitBounds(bounds, {padding: '10'});
});

map.on('load', function () {
    // Add park marker data from previously defined GeoJSON source.
    map.addSource("park_markers", park_markers_source);

    // // Add turf data.
    // map.addSource('turf-data', {
    //     "type": "geojson",
    //     "data": grid
    // });

    // // Add turf.
    // map.addLayer({
    //     "id": "turf-data",
    //     "type": "circle",
    //     "source": "turf-data",
    //     "paint": {
    //         "circle-color": "#f00",
    //         "circle-radius": 5
    //     }
    // });

    // grid.features.forEach(function (feature) {
    //     feature.properties["marker-color"] = "#6BC65F";
    //     feature.properties["marker-size"] = "small";
    // });

    // Add origin point as a new GeoJSON source.
    map.addSource('origin-point', {
        "type": "geojson",
        "data": origin
    });

    // Add a layer showing the origin point.
    map.addLayer({
        "id": "origin-point",
        "type": "circle",
        "source": "origin-point",
        "layout": {
            'visibility': 'visible'
        },
        "paint": {
            "circle-radius": 12,
            "circle-color": "#007cbf",
            "circle-opacity": 0.9
        }
    });

    // Add a layer showing the markers.
    map.addLayer({
        "id": "park_markers",
        "type": "circle",
        "source": "park_markers",
        "filter": ["<=", 'routing_mins', time],
        "layout": {
            "visibility": 'visible'
        },
        'paint': {
            'circle-radius': 11,
            // 'circle-radius': { // interpolate based on routing distance??
            //     'property': routing_time,
            //     'stops': [
            //         [routing_time*0.33, 9],
            //         [routing_time*0.66, 11],
            //         [routing_time, 13]
            //     ]
            // },
            'circle-color': '#00b300',
            'circle-opacity': 0.8
        }
    });

    // Add a layer showing a user's favorites.
    map.addLayer({
        "id": "fav-markers",
        "type": "circle",
        "source": "park_markers",
        "filter": ["==", 'favorite', 'favorite'],
        "layout": {
            'visibility': 'visible' 
        },
        'paint': { 
            'circle-radius': 11, // units in pixels
            'circle-color': '#ff00bf',
            'circle-opacity': 1.0
        },
    });
});


// Add functionality for toggling layers via menu selection.
// addLayer('Privately Owned Public Open Spaces', 'popos_markers');
// addLayer('SF public parks', 'posm_markers');
// addLayer('Parks', 'park_markers');
addLayer('My Favorites', 'fav-markers');

function addLayer(name, id) {
    var link = document.createElement('a');
    link.href = '#';
    link.className = 'active';
    link.textContent = name;

    link.onclick = function (e) {
        e.preventDefault();
        e.stopPropagation();

        var visibility = map.getLayoutProperty(id, 'visibility');

        if (visibility === 'visible') {
            map.setLayoutProperty(id, 'visibility', 'none');
            this.className = '';
        } else {
            this.className = 'active';
            map.setLayoutProperty(id, 'visibility', 'visible');
        }
    };

    var layers = document.getElementById('menu');
    layers.appendChild(link);
}
// End toggle layers.


// Helper function for lat/lng verification
// map.on('mousemove', function (e) {
//     document.getElementById('info').innerHTML =
//         // e.point is the x, y coordinates of the mousemove event relative
//         // to the top-left corner of the map
//         JSON.stringify(e.point) + '<br />' +
//         // e.lngLat is the longitude, latitude geographical position of the event
//         JSON.stringify(e.lngLat);
// });


</script>
<script src='/static/js/map.js'></script>
<script src='/static/js/turf.js'></script>

{% endblock %}